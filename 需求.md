# MCPLink - AI Agent 工具调用框架

## 项目背景

实现一个完整的 AI Agent 解决方案，包含：

1. **核心 SDK**：Node.js npm 包，提供 AI 模型调用、MCP 工具管理、Agent 引擎
2. **后端服务**：基于 SDK 的 HTTP 服务，提供 RESTful API
3. **前端网页**：类似 CherryStudio 的网页版 AI 对话工具

让 AI 自主理解用户意图、拆解任务、调用已配置的 MCP 工具来完成整个工作流。类似于 Cursor、CherryStudio 这种 AI Agent 能力：与 AI 对话 → AI 理解并拆解任务 → 逐个执行任务 → 检查结果 → 循环直到完成。

### 应用场景

**场景一：作为独立产品使用（网页版 CherryStudio）**
- 用户部署后端服务
- 通过网页配置 AI 模型和 MCP 工具
- 直接在网页上与 AI 对话，完成各种任务

**场景二：集成到现有系统（SDK 方式）**
- 引入 npm 包到现有 Node.js 项目
- 封装业务 API 为 MCP 工具
- 实现智能客服、自动化工作流等功能

---

## 系统架构

```
┌─────────────────┐         ┌──────────────────────────────────┐
│    前端网页      │  API    │      Node.js 后端                 │
│  (调用接口即可)   │ ◄─────► │  ┌────────────────────────────┐  │
└─────────────────┘         │  │   MCPLink (本项目)          │  │
                            │  │  • AI 模型配置/调用          │  │
                            │  │  • MCP 工具配置/执行         │  │
                            │  │  • Agent 任务编排            │  │
                            │  └────────────────────────────┘  │
                            └──────────────────────────────────┘
                                           │
                                           ▼
                            ┌──────────────────────────────────┐
                            │         MCP 工具服务              │
                            │  • 业务系统 API (订单/用户/工单)   │
                            │  • 第三方服务 (GitHub/数据库等)    │
                            └──────────────────────────────────┘
```

---

## 技术要求

- **运行环境**：Node.js 后端
- **开发语言**：TypeScript
- **包管理**：npm 包形式发布
- **MCP 协议**：支持 stdio 和 SSE 两种传输方式

### 核心依赖

| 依赖 | 版本 | 用途 |
|------|------|------|
| `ai` | ^4.x | Vercel AI SDK，统一的 AI 模型调用接口 |
| `@ai-sdk/openai` | ^1.x | OpenAI 模型支持 |
| `@ai-sdk/anthropic` | ^1.x | Claude 模型支持 |
| `@modelcontextprotocol/sdk` | ^1.x | MCP 官方 SDK，处理 MCP 协议通信 |
| `zod` | ^3.x | 参数校验（AI SDK 依赖） |

### 为什么选择这些 SDK

**Vercel AI SDK (`ai`)**
- 统一接口：一套代码支持所有主流模型
- 内置 Tool Calling：原生支持函数调用，与 MCP 工具无缝衔接
- 流式输出：开箱即用的 streaming 支持
- 活跃维护：Vercel 团队维护，更新及时

**MCP SDK (`@modelcontextprotocol/sdk`)**
- 官方实现：Anthropic 官方出品，协议兼容性最好
- 完整支持：stdio/SSE 传输、工具发现、资源管理都有
- 类型完善：TypeScript 类型定义完整

---

## 核心功能模块

### 1. AI 模型管理

基于 **Vercel AI SDK**，支持配置和切换多种大语言模型：

| 模型厂商 | 支持模型 | SDK 包 |
|---------|---------|--------|
| OpenAI | GPT-4、GPT-4o、GPT-4o-mini 等 | `@ai-sdk/openai` |
| Anthropic | Claude 3.5、Claude 3 等 | `@ai-sdk/anthropic` |
| Google | Gemini Pro、Gemini Flash 等 | `@ai-sdk/google` |
| DeepSeek | DeepSeek-V3、DeepSeek-R1 等 | `@ai-sdk/deepseek` |
| 其他 | 通义千问、Mistral 等 | 通过 OpenAI 兼容接口 |

配置方式：
```typescript
// 直接传入 Vercel AI SDK 的 model 实例
import { openai } from '@ai-sdk/openai'
import { anthropic } from '@ai-sdk/anthropic'

const agent = new MCPLink({
  model: openai('gpt-4o'),  // 或 anthropic('claude-3-5-sonnet-20241022')
  // ...
})
```

### 2. MCP 工具管理

支持配置和管理 MCP (Model Context Protocol) 工具服务：

- **加载方式**：
  - stdio 模式：通过命令行启动 MCP 服务
  - SSE 模式：连接远程 MCP 服务
  
- **工具发现**：自动获取 MCP 服务提供的工具列表和参数定义

- **工具执行**：根据 AI 决策调用对应工具并返回结果

配置示例：
```typescript
mcpServers: {
  // stdio 模式
  github: {
    command: 'npx',
    args: ['-y', '@modelcontextprotocol/server-github'],
    env: { GITHUB_TOKEN: 'xxx' }
  },
  // SSE 模式
  business: {
    type: 'sse',
    url: 'http://localhost:3001/mcp'
  }
}
```

### 3. Agent 引擎（核心）

这是整个系统的核心，实现类似 Cursor 的 AI Agent 能力：**理解任务 → 自主规划 → 逐步执行 → 验证完成**。

#### 3.1 工作流程总览

```
┌─────────────────────────────────────────────────────────────────┐
│                        用户输入复杂任务                          │
│  "给我查查电磁阀相关产品添加到购物车，我要做一个报价单"            │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                    第一步：任务理解与规划                         │
│  AI 分析用户意图，识别出需要完成的子任务：                        │
│  1. 搜索"电磁阀"相关产品                                         │
│  2. 筛选合适的产品                                               │
│  3. 将产品添加到购物车                                           │
│  4. 生成报价单                                                   │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                    第二步：执行循环 (ReAct)                       │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  Thought: 我需要先搜索电磁阀相关产品                      │   │
│  │  Action:  调用 search_products 工具                      │   │
│  │  Observation: 返回了 15 个产品结果                        │   │
│  └─────────────────────────────────────────────────────────┘   │
│                         ↓                                       │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  Thought: 搜索到产品了，现在需要添加到购物车              │   │
│  │  Action:  调用 add_to_cart 工具 (批量添加)               │   │
│  │  Observation: 成功添加 15 个产品到购物车                  │   │
│  └─────────────────────────────────────────────────────────┘   │
│                         ↓                                       │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  Thought: 产品已加入购物车，现在生成报价单                │   │
│  │  Action:  调用 generate_quotation 工具                   │   │
│  │  Observation: 报价单已生成，编号 Q2024121700001          │   │
│  └─────────────────────────────────────────────────────────┘   │
│                         ↓                                       │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  Thought: 所有任务已完成！                                │   │
│  │  ✓ 搜索产品 - 完成                                       │   │
│  │  ✓ 添加购物车 - 完成                                     │   │
│  │  ✓ 生成报价单 - 完成                                     │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                      第三步：生成最终回复                         │
│  "已为您完成以下操作：                                           │
│   1. 搜索到 15 个电磁阀相关产品                                  │
│   2. 已全部添加到购物车                                          │
│   3. 已生成报价单，编号：Q2024121700001                          │
│   您可以点击这里查看报价单详情..."                                │
└─────────────────────────────────────────────────────────────────┘
```

#### 3.2 核心能力

| 能力 | 说明 | 实现方式 |
|------|------|---------|
| **任务规划** | AI 自主理解复杂任务，拆解为可执行步骤 | System Prompt 引导 + 思维链 |
| **工具选择** | 根据当前步骤智能选择合适的 MCP 工具 | Vercel AI SDK Tool Calling |
| **执行反馈** | 执行工具后获取结果，作为下一步决策依据 | 工具结果注入上下文 |
| **完成判断** | AI 自主判断任务是否全部完成 | 多轮对话 + 状态追踪 |
| **异常处理** | 工具调用失败时，AI 尝试其他方案或告知用户 | 错误信息反馈给 AI |

#### 3.3 Agent 循环伪代码

```typescript
async function agentLoop(userMessage: string) {
  const messages = [
    { role: 'system', content: SYSTEM_PROMPT },
    { role: 'user', content: userMessage }
  ]
  
  let iteration = 0
  
  while (iteration < maxIterations) {
    // 调用 AI，可能返回文本或工具调用请求
    const response = await generateText({
      model,
      messages,
      tools: mcpTools,  // MCP 工具转换为 AI SDK 格式
    })
    
    // 如果 AI 没有调用工具，说明任务完成或不需要工具
    if (!response.toolCalls || response.toolCalls.length === 0) {
      return response.text  // 返回最终回复
    }
    
    // 执行所有工具调用
    const toolResults = await Promise.all(
      response.toolCalls.map(async (toolCall) => {
        const result = await executeMCPTool(toolCall.name, toolCall.args)
        return { toolCallId: toolCall.id, result }
      })
    )
    
    // 将 AI 的回复和工具结果加入上下文
    messages.push({ role: 'assistant', content: response.text, toolCalls: response.toolCalls })
    messages.push({ role: 'tool', content: toolResults })
    
    iteration++
  }
  
  return '任务执行超过最大轮次限制'
}
```

#### 3.4 System Prompt 设计

System Prompt 是引导 AI 正确工作的关键：

```
你是一个智能助手，可以通过调用工具来帮助用户完成任务。

## 工作方式

1. **理解任务**：仔细分析用户的需求，理解他们想要达成的目标
2. **规划步骤**：将复杂任务拆解为可执行的步骤
3. **逐步执行**：每次选择最合适的工具，执行一个步骤
4. **检查结果**：分析工具返回的结果，判断是否成功
5. **继续或完成**：如果还有未完成的步骤，继续执行；否则总结结果回复用户

## 注意事项

- 每次只调用必要的工具，不要过度调用
- 如果工具调用失败，分析原因并尝试其他方案
- 如果无法完成任务，诚实告知用户原因
- 完成所有步骤后，用清晰的语言总结执行结果

## 可用工具

{工具列表和描述，从 MCP 服务获取}
```

#### 3.5 实际场景示例

**场景**：用户说"给我查查电磁阀相关产品添加到购物车，我要做一个报价单"

**可用的 MCP 工具**：
| 工具名 | 描述 | 参数 |
|--------|------|------|
| `search_products` | 搜索产品 | `keyword`, `category`, `limit` |
| `get_product_detail` | 获取产品详情 | `productId` |
| `add_to_cart` | 添加到购物车 | `productIds[]`, `quantities[]` |
| `generate_quotation` | 生成报价单 | `cartId`, `customerId` |

**Agent 执行过程**：

| 轮次 | AI 思考 | 调用工具 | 结果 |
|------|--------|---------|------|
| 1 | 用户想要电磁阀产品并生成报价单，先搜索产品 | `search_products({ keyword: '电磁阀' })` | 返回 15 个产品 |
| 2 | 搜索到产品了，需要添加到购物车 | `add_to_cart({ productIds: [...] })` | 添加成功，cartId: 123 |
| 3 | 购物车已有产品，现在生成报价单 | `generate_quotation({ cartId: 123 })` | 报价单 Q2024121700001 |
| 4 | 所有步骤完成，回复用户 | （无工具调用） | 生成总结回复 |

#### 3.6 配置选项

```typescript
new MCPLink({
  model: openai('gpt-4o'),
  mcpServers: { ... },
  
  // Agent 相关配置
  maxIterations: 10,          // 最大循环次数，防止无限循环
  systemPrompt: '...',        // 自定义系统提示词
  
  // 高级配置
  planningMode: 'auto',       // 'auto' | 'explicit' - 是否显式输出任务计划
  parallelToolCalls: true,    // 是否允许并行调用多个工具
  continueOnError: true,      // 工具调用失败时是否继续尝试
})
```

### 4. 对话管理

- **上下文维护**：保持对话历史，支持多轮对话
- **消息格式**：统一的消息结构（role、content、toolCalls 等）
- **会话隔离**：支持多会话并发

### 5. 执行过程可视化（事件流）

类似 Cursor，提供完整的执行过程可视化能力，让前端可以实时展示 AI 的思考、工具调用、执行结果等全过程。

#### 5.1 事件流设计

```
┌─────────────────────────────────────────────────────────────────┐
│                         前端展示效果                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  👤 用户: 给我查查电磁阀相关产品添加到购物车，我要做一个报价单    │
│                                                                 │
│  🤖 AI 正在思考...                                              │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ 💭 思考: 用户需要搜索电磁阀产品、添加购物车、生成报价单    │   │
│  │         我需要分步骤完成这个任务                          │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ 🔧 调用工具: search_products                             │   │
│  │    参数: { "keyword": "电磁阀", "limit": 20 }            │   │
│  │    状态: 执行中... ⏳                                     │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ ✅ 工具返回: search_products                             │   │
│  │    耗时: 230ms                                           │   │
│  │    结果: 找到 15 个产品                                   │   │
│  │    [展开查看详情]                                         │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ 💭 思考: 搜索到 15 个产品，现在需要添加到购物车           │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ 🔧 调用工具: add_to_cart                                 │   │
│  │    参数: { "productIds": ["P001", "P002", ...] }         │   │
│  │    状态: ✅ 完成 (180ms)                                  │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  ... 更多步骤 ...                                               │
│                                                                 │
│  🤖 AI: 已为您完成以下操作：                                    │
│      1. ✅ 搜索到 15 个电磁阀相关产品                           │
│      2. ✅ 已全部添加到购物车                                   │
│      3. ✅ 已生成报价单，编号：Q2024121700001                   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

#### 5.2 事件类型定义

```typescript
// 事件类型枚举
enum MCPLinkEventType {
  // AI 相关
  THINKING_START = 'thinking_start',      // AI 开始思考
  THINKING_DELTA = 'thinking_delta',      // AI 思考内容流式输出
  THINKING_END = 'thinking_end',          // AI 思考结束
  
  // 文本输出
  TEXT_DELTA = 'text_delta',              // AI 回复内容流式输出
  TEXT_END = 'text_end',                  // AI 回复结束
  
  // 工具调用
  TOOL_CALL_START = 'tool_call_start',    // 开始调用工具
  TOOL_CALL_DELTA = 'tool_call_delta',    // 工具参数流式输出（可选）
  TOOL_CALL_END = 'tool_call_end',        // 工具调用参数完成
  TOOL_RESULT = 'tool_result',            // 工具返回结果
  
  // 任务状态
  ITERATION_START = 'iteration_start',    // 开始新一轮循环
  ITERATION_END = 'iteration_end',        // 一轮循环结束
  COMPLETE = 'complete',                  // 全部任务完成
  ERROR = 'error',                        // 发生错误
}

// 事件数据结构
interface MCPLinkEvent {
  type: MCPLinkEventType
  timestamp: number
  data: {
    // 根据事件类型不同，包含不同数据
    content?: string          // 文本内容
    toolName?: string         // 工具名称
    toolArgs?: object         // 工具参数
    toolResult?: any          // 工具结果
    duration?: number         // 执行耗时(ms)
    iteration?: number        // 当前轮次
    error?: Error             // 错误信息
  }
}
```

#### 5.3 使用方式

**方式一：回调函数**

```typescript
const result = await agent.chat('查询电磁阀产品并生成报价单', {
  // AI 思考过程
  onThinking: (content: string) => {
    console.log('💭 思考:', content)
  },
  
  // 开始调用工具
  onToolCallStart: (toolName: string, args: object) => {
    console.log(`🔧 调用工具: ${toolName}`)
    console.log(`   参数:`, args)
  },
  
  // 工具返回结果
  onToolResult: (toolName: string, result: any, duration: number) => {
    console.log(`✅ ${toolName} 完成 (${duration}ms)`)
    console.log(`   结果:`, result)
  },
  
  // AI 输出文本（流式）
  onTextDelta: (delta: string) => {
    process.stdout.write(delta)
  },
  
  // 发生错误
  onError: (error: Error) => {
    console.error('❌ 错误:', error.message)
  }
})
```

**方式二：事件流（适合 SSE 推送给前端）**

```typescript
const stream = agent.chatStream('查询电磁阀产品并生成报价单')

for await (const event of stream) {
  // 将事件推送给前端
  res.write(`data: ${JSON.stringify(event)}\n\n`)
  
  // 或者根据事件类型处理
  switch (event.type) {
    case 'thinking_delta':
      // 更新思考内容
      break
    case 'tool_call_start':
      // 显示工具调用卡片
      break
    case 'tool_result':
      // 更新工具结果
      break
    case 'text_delta':
      // 追加 AI 回复
      break
  }
}
```

**方式三：HTTP 接口（给前端调用）**

```typescript
// Express 示例
app.post('/api/chat', async (req, res) => {
  const { message } = req.body
  
  // 设置 SSE 响应头
  res.setHeader('Content-Type', 'text/event-stream')
  res.setHeader('Cache-Control', 'no-cache')
  res.setHeader('Connection', 'keep-alive')
  
  const stream = agent.chatStream(message)
  
  for await (const event of stream) {
    res.write(`event: ${event.type}\n`)
    res.write(`data: ${JSON.stringify(event.data)}\n\n`)
  }
  
  res.end()
})
```

#### 5.4 前端展示建议

| 事件类型 | 展示方式 |
|---------|---------|
| `thinking_*` | 灰色斜体文字，可折叠的思考过程卡片 |
| `tool_call_start` | 工具卡片，显示工具名和参数，带 loading 状态 |
| `tool_result` | 更新工具卡片状态为完成，显示耗时和结果摘要 |
| `text_delta` | 正常的 AI 回复气泡，打字机效果 |
| `error` | 红色错误提示卡片 |

#### 5.5 完整事件流示例

一次完整的对话会产生如下事件序列：

```json
{"type":"iteration_start","data":{"iteration":1}}
{"type":"thinking_start","data":{}}
{"type":"thinking_delta","data":{"content":"用户想要搜索电磁阀产品"}}
{"type":"thinking_delta","data":{"content":"，添加到购物车，然后生成报价单"}}
{"type":"thinking_end","data":{}}
{"type":"tool_call_start","data":{"toolName":"search_products","toolArgs":{"keyword":"电磁阀"}}}
{"type":"tool_result","data":{"toolName":"search_products","result":{"count":15,"products":[...]},"duration":230}}
{"type":"iteration_end","data":{"iteration":1}}

{"type":"iteration_start","data":{"iteration":2}}
{"type":"thinking_delta","data":{"content":"搜索到15个产品，现在添加到购物车"}}
{"type":"tool_call_start","data":{"toolName":"add_to_cart","toolArgs":{"productIds":["P001","P002"]}}}
{"type":"tool_result","data":{"toolName":"add_to_cart","result":{"cartId":123},"duration":180}}
{"type":"iteration_end","data":{"iteration":2}}

{"type":"iteration_start","data":{"iteration":3}}
{"type":"tool_call_start","data":{"toolName":"generate_quotation","toolArgs":{"cartId":123}}}
{"type":"tool_result","data":{"toolName":"generate_quotation","result":{"quotationNo":"Q2024121700001"},"duration":350}}
{"type":"iteration_end","data":{"iteration":3}}

{"type":"iteration_start","data":{"iteration":4}}
{"type":"text_delta","data":{"content":"已为您完成以下操作：\n"}}
{"type":"text_delta","data":{"content":"1. ✅ 搜索到15个电磁阀相关产品\n"}}
{"type":"text_delta","data":{"content":"2. ✅ 已全部添加到购物车\n"}}
{"type":"text_delta","data":{"content":"3. ✅ 已生成报价单，编号：Q2024121700001"}}
{"type":"text_end","data":{}}
{"type":"complete","data":{"totalIterations":4,"totalDuration":1250}}

---

## API 设计

### 初始化

```typescript
import { MCPLink } from 'mcplink'
import { openai } from '@ai-sdk/openai'

const agent = new MCPLink({
  // 直接传入 Vercel AI SDK 的 model
  model: openai('gpt-4o'),
  
  // MCP 服务配置
  mcpServers: {
    business: {
      command: 'node',
      args: ['./mcp-servers/business.js']
    }
  },
  
  // 可选配置
  maxIterations: 10,        // 最大工具调用轮次
  systemPrompt: '你是一个智能客服助手...'  // 系统提示词
})
```

### 发起对话

```typescript
// 简单调用
const result = await agent.chat('帮我查一下订单 #12345 的状态')

// 流式调用
const stream = await agent.chatStream('帮我查一下订单状态', {
  onToolCall: (tool) => console.log('调用工具:', tool.name),
  onToolResult: (result) => console.log('工具结果:', result)
})

for await (const chunk of stream) {
  process.stdout.write(chunk.content)
}
```

### 返回结构

```typescript
interface ChatResult {
  // 最终回复内容
  content: string
  // 执行过的工具调用记录
  toolCalls: Array<{
    name: string
    arguments: Record<string, any>
    result: any
  }>
  // 完整对话历史
  messages: Message[]
  // 使用的 token 数量
  usage: {
    promptTokens: number
    completionTokens: number
    totalTokens: number
  }
}
```

### 工具管理

```typescript
// 获取所有已加载的工具
const tools = await agent.getTools()

// 手动添加工具（不通过 MCP）
agent.addTool({
  name: 'custom_tool',
  description: '自定义工具',
  parameters: { /* JSON Schema */ },
  handler: async (args) => { /* 执行逻辑 */ }
})
```

### 生命周期

```typescript
// 初始化连接所有 MCP 服务
await agent.initialize()

// 关闭所有连接
await agent.close()
```

---

## 目录结构

```
mcplink/
├── packages/
│   ├── core/                     # 核心 SDK (npm 包)
│   │   ├── src/
│   │   │   ├── index.ts          # 入口文件，导出主类和类型
│   │   │   ├── MCPLink.ts        # 主类，整合 AI 和 MCP
│   │   │   ├── Agent.ts          # Agent 引擎，任务循环逻辑
│   │   │   ├── MCPManager.ts     # MCP 服务管理
│   │   │   ├── AIModelFactory.ts # AI 模型工厂
│   │   │   └── types.ts          # 类型定义
│   │   └── package.json
│   │
│   ├── server/                   # 后端服务
│   │   ├── src/
│   │   │   ├── index.ts          # 服务入口
│   │   │   ├── routes/           # API 路由
│   │   │   │   ├── chat.ts       # 对话相关 API
│   │   │   │   ├── models.ts     # 模型管理 API
│   │   │   │   ├── mcp.ts        # MCP 工具管理 API
│   │   │   │   └── config.ts     # 配置管理 API
│   │   │   ├── services/         # 业务逻辑
│   │   │   └── config/           # 配置文件管理
│   │   └── package.json
│   │
│   └── web/                      # 前端网页 (Vue)
│       ├── src/
│       │   ├── views/            # 页面
│       │   │   ├── Chat.vue      # 对话页面
│       │   │   └── Settings.vue  # 设置页面
│       │   ├── components/       # 组件
│       │   │   ├── ChatMessage.vue
│       │   │   ├── ThinkingCard.vue
│       │   │   ├── ToolCallCard.vue
│       │   │   ├── ModelSelector.vue
│       │   │   └── MCPToolList.vue
│       │   ├── stores/           # Pinia 状态管理
│       │   └── api/              # API 调用
│       └── package.json
│
├── package.json                  # monorepo 根配置
├── pnpm-workspace.yaml
└── README.md
```

> 💡 采用 **Monorepo** 结构管理多个包：
> - `packages/core`: 核心 SDK，可独立发布到 npm
> - `packages/server`: 后端服务，依赖 core
> - `packages/web`: 前端网页，调用 server API

---

## 前端网页设计

### 技术栈

| 技术 | 说明 |
|------|------|
| Vue 3 | 前端框架 |
| TypeScript | 类型安全 |
| Pinia | 状态管理 |
| Vue Router | 路由管理 |
| Tailwind CSS | 样式框架 |
| SSE | 实时事件流 |

### 页面结构

```
┌─────────────────────────────────────────────────────────────────────────┐
│  MCPLink                                    [模型: GPT-4o ▼]  [⚙️ 设置]  │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌─ 会话列表 ─┐  ┌─────────────────────────────────────────────────┐   │
│  │            │  │                                                 │   │
│  │ 📝 新对话   │  │  👤 给我查查电磁阀相关产品添加到购物车，         │   │
│  │            │  │     我要做一个报价单                             │   │
│  │ 💬 对话1   │  │                                                 │   │
│  │ 💬 对话2   │  │  🤖 ─────────────────────────────────────────   │   │
│  │ 💬 对话3   │  │     💭 思考: 需要搜索产品、添加购物车、生成报价   │   │
│  │            │  │                                                 │   │
│  │            │  │     🔧 search_products                          │   │
│  │            │  │        keyword: "电磁阀"                         │   │
│  │            │  │        ✅ 完成 (230ms) - 找到15个产品            │   │
│  │            │  │                                                 │   │
│  │            │  │     🔧 add_to_cart                               │   │
│  │            │  │        productIds: ["P001", "P002", ...]        │   │
│  │            │  │        ✅ 完成 (180ms)                           │   │
│  │            │  │                                                 │   │
│  │            │  │     🔧 generate_quotation                        │   │
│  │            │  │        ⏳ 执行中...                              │   │
│  │            │  │                                                 │   │
│  └────────────┘  └─────────────────────────────────────────────────┘   │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  输入消息...                                            [发送]  │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 设置页面

```
┌─────────────────────────────────────────────────────────────────────────┐
│  ⚙️ 设置                                                      [← 返回]  │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌─ 分类 ─────┐  ┌─────────────────────────────────────────────────┐   │
│  │            │  │                                                 │   │
│  │ 🔗 服务    │  │  后端服务配置                                    │   │
│  │ 🤖 模型    │  │  ─────────────────────────────────              │   │
│  │ 🔧 MCP工具 │  │                                                 │   │
│  │ 📝 提示词  │  │  服务地址: [http://localhost:3000      ]        │   │
│  │ 🎨 外观    │  │                                                 │   │
│  │            │  │  [测试连接]  状态: ✅ 已连接                     │   │
│  │            │  │                                                 │   │
│  │            │  │  💡 提示：你可以在本地运行后端服务，              │   │
│  │            │  │     然后将地址改为 http://localhost:3000        │   │
│  │            │  │                                                 │   │
│  └────────────┘  └─────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 核心功能

#### 1. 服务配置

| 功能 | 说明 |
|------|------|
| 切换后端地址 | 支持自定义后端服务地址，用户可以本地部署 |
| 连接测试 | 验证后端服务是否可用 |
| 多服务管理 | 保存多个后端地址，快速切换 |

```typescript
// 前端存储
interface ServiceConfig {
  name: string           // 服务名称，如 "本地服务"、"云端服务"
  url: string            // 服务地址
  isActive: boolean      // 是否当前使用
}
```

#### 2. 模型管理

| 功能 | 说明 |
|------|------|
| 查看模型列表 | 展示所有已配置的 AI 模型 |
| 切换模型 | 对话时选择使用哪个模型 |
| 启用/停用 | 控制模型是否可用 |
| 新增模型 | 添加新的模型配置 |
| 编辑/删除 | 修改或删除模型配置 |

```
┌─────────────────────────────────────────────────────────────────┐
│  🤖 模型管理                                        [+ 添加模型] │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  GPT-4o                                    [启用] [编辑] │   │
│  │  Provider: OpenAI                                        │   │
│  │  Model: gpt-4o                                           │   │
│  │  ✅ 已启用                                                │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  Claude 3.5 Sonnet                        [停用] [编辑] │   │
│  │  Provider: Anthropic                                     │   │
│  │  Model: claude-3-5-sonnet-20241022                       │   │
│  │  ⚪ 已停用                                                │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  DeepSeek-V3                              [启用] [编辑] │   │
│  │  Provider: OpenAI Compatible                             │   │
│  │  BaseURL: https://api.deepseek.com                       │   │
│  │  ✅ 已启用                                                │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

模型配置表单：

```
┌─────────────────────────────────────────────────────────────────┐
│  添加模型                                              [× 关闭] │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  名称:      [GPT-4o                        ]                    │
│                                                                 │
│  提供商:    [OpenAI              ▼]                             │
│             • OpenAI                                            │
│             • Anthropic                                         │
│             • Google                                            │
│             • DeepSeek                                          │
│             • OpenAI 兼容                                       │
│                                                                 │
│  模型:      [gpt-4o                        ]                    │
│                                                                 │
│  API Key:   [sk-****************************]                   │
│                                                                 │
│  Base URL:  [https://api.openai.com        ] (可选)             │
│                                                                 │
│  ─── 高级配置 ─────────────────────────────────────────────     │
│                                                                 │
│  Temperature: [0.7    ]                                         │
│  Max Tokens:  [4096   ]                                         │
│                                                                 │
│                                    [取消]  [保存]               │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

#### 3. MCP 工具管理

| 功能 | 说明 |
|------|------|
| 查看工具列表 | 展示所有已配置的 MCP 服务及其工具 |
| 启用/停用 | 控制 MCP 服务是否启用 |
| 新增 MCP 服务 | 添加新的 MCP 服务配置 |
| 编辑/删除 | 修改或删除 MCP 服务配置 |
| 查看工具详情 | 查看 MCP 服务提供的工具列表和参数说明 |
| 测试工具 | 手动测试工具调用 |

```
┌─────────────────────────────────────────────────────────────────┐
│  🔧 MCP 工具管理                                   [+ 添加服务] │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  📦 business-api                  [运行中] [停止] [编辑] │   │
│  │  类型: stdio                                             │   │
│  │  命令: node ./mcp-servers/business.js                    │   │
│  │                                                          │   │
│  │  提供的工具 (4个):                          [展开/收起]   │   │
│  │  ├─ search_products    搜索产品                          │   │
│  │  ├─ get_product_detail 获取产品详情                      │   │
│  │  ├─ add_to_cart        添加到购物车                      │   │
│  │  └─ generate_quotation 生成报价单                        │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  📦 github                              [已停止] [启动]  │   │
│  │  类型: stdio                                             │   │
│  │  命令: npx -y @modelcontextprotocol/server-github        │   │
│  │                                                          │   │
│  │  提供的工具: (未启动，启动后可查看)                       │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  📦 remote-service                      [运行中] [停止]  │   │
│  │  类型: SSE                                               │   │
│  │  地址: http://192.168.1.100:3001/mcp                     │   │
│  │                                                          │   │
│  │  提供的工具 (2个):                                       │   │
│  │  ├─ query_database     查询数据库                        │   │
│  │  └─ send_notification  发送通知                          │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

MCP 服务配置表单：

```
┌─────────────────────────────────────────────────────────────────┐
│  添加 MCP 服务                                         [× 关闭] │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  服务名称:  [business-api                  ]                    │
│                                                                 │
│  连接类型:  ○ stdio (本地命令)    ● SSE (远程服务)              │
│                                                                 │
│  ─── stdio 配置 ────────────────────────────────────────────    │
│                                                                 │
│  启动命令:  [node                          ]                    │
│  参数:      [./mcp-servers/business.js     ]                    │
│                                                                 │
│  环境变量:                                          [+ 添加]    │
│  ┌──────────────────────────────────────────────────────┐      │
│  │  API_KEY    =  [sk-xxx...          ]        [删除]   │      │
│  │  DB_HOST    =  [localhost          ]        [删除]   │      │
│  └──────────────────────────────────────────────────────┘      │
│                                                                 │
│  ─── SSE 配置 ──────────────────────────────────────────────    │
│                                                                 │
│  服务地址:  [http://localhost:3001/mcp     ]                    │
│                                                                 │
│  ☑ 启动后自动连接                                               │
│                                                                 │
│                                    [取消]  [保存]               │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

#### 4. 对话功能

| 功能 | 说明 |
|------|------|
| 多会话管理 | 支持多个独立会话，可切换、删除 |
| 实时展示 | 流式显示 AI 回复、思考过程、工具调用 |
| 模型切换 | 对话时可切换使用的模型 |
| 导出对话 | 导出对话历史为 Markdown/JSON |
| 清空上下文 | 清除当前会话的上下文 |

#### 5. System Prompt 管理

| 功能 | 说明 |
|------|------|
| 默认提示词 | 设置默认的系统提示词 |
| 提示词模板 | 保存多个提示词模板，快速切换 |
| 会话级提示词 | 为单个会话设置独立的系统提示词 |

---

## 后端服务设计

### 技术栈

| 技术 | 说明 |
|------|------|
| Node.js | 运行环境 |
| Express / Hono | HTTP 框架 |
| TypeScript | 类型安全 |
| SQLite | 本地存储配置数据（可选） |

### API 设计

#### 对话相关

```
POST   /api/chat              # 发起对话（SSE 流式响应）
GET    /api/conversations     # 获取会话列表
GET    /api/conversations/:id # 获取单个会话详情
DELETE /api/conversations/:id # 删除会话
```

#### 模型管理

```
GET    /api/models            # 获取模型列表
POST   /api/models            # 添加模型
PUT    /api/models/:id        # 更新模型配置
DELETE /api/models/:id        # 删除模型
PUT    /api/models/:id/toggle # 启用/停用模型
```

#### MCP 工具管理

```
GET    /api/mcp/servers           # 获取 MCP 服务列表
POST   /api/mcp/servers           # 添加 MCP 服务
PUT    /api/mcp/servers/:id       # 更新 MCP 服务配置
DELETE /api/mcp/servers/:id       # 删除 MCP 服务
POST   /api/mcp/servers/:id/start # 启动 MCP 服务
POST   /api/mcp/servers/:id/stop  # 停止 MCP 服务
GET    /api/mcp/servers/:id/tools # 获取 MCP 服务的工具列表
POST   /api/mcp/tools/test        # 测试工具调用
```

#### 系统配置

```
GET    /api/config                # 获取系统配置
PUT    /api/config                # 更新系统配置
GET    /api/health                # 健康检查（前端测试连接用）
```

### 配置存储

配置数据存储在本地文件中（JSON 或 SQLite）：

```
config/
├── models.json      # 模型配置
├── mcp-servers.json # MCP 服务配置
├── prompts.json     # 提示词模板
└── settings.json    # 系统设置
```

示例 `models.json`：

```json
{
  "models": [
    {
      "id": "gpt-4o",
      "name": "GPT-4o",
      "provider": "openai",
      "model": "gpt-4o",
      "apiKey": "sk-xxx",
      "enabled": true,
      "config": {
        "temperature": 0.7,
        "maxTokens": 4096
      }
    }
  ]
}
```

示例 `mcp-servers.json`：

```json
{
  "servers": [
    {
      "id": "business-api",
      "name": "业务 API",
      "type": "stdio",
      "command": "node",
      "args": ["./mcp-servers/business.js"],
      "env": {
        "API_KEY": "xxx"
      },
      "enabled": true,
      "autoStart": true
    }
  ]
}
```

---

## 开发计划

### 第一阶段：核心 SDK
- [ ] 项目初始化，搭建 Monorepo 结构
- [ ] 实现 AI 模型工厂（基于 Vercel AI SDK）
- [ ] 实现 MCP 管理器（基于 @modelcontextprotocol/sdk）
- [ ] 实现基础对话功能

### 第二阶段：Agent 引擎
- [ ] 实现 Agent 循环逻辑
- [ ] 实现任务拆解和多轮调用
- [ ] 实现事件流机制（思考/工具调用/结果）
- [ ] 流式输出支持

### 第三阶段：后端服务
- [ ] 搭建 Express/Hono 服务框架
- [ ] 实现对话 API（SSE 流式响应）
- [ ] 实现模型管理 API
- [ ] 实现 MCP 服务管理 API
- [ ] 实现配置文件存储

### 第四阶段：前端网页
- [ ] 搭建 Vue 3 项目结构
- [ ] 实现对话界面（消息列表、思考卡片、工具卡片）
- [ ] 实现设置页面（服务配置、模型管理、MCP 管理）
- [ ] 实现 SSE 事件流处理
- [ ] 实现多会话管理

### 第五阶段：完善和优化
- [ ] 完善错误处理和重试机制
- [ ] 添加更多 AI 模型支持
- [ ] UI 细节优化
- [ ] 文档和使用示例
- [ ] Docker 部署方案

---

## 参考资料

- [MCP 协议规范](https://modelcontextprotocol.io/)
- [OpenAI Function Calling](https://platform.openai.com/docs/guides/function-calling)
- [Anthropic Tool Use](https://docs.anthropic.com/claude/docs/tool-use)